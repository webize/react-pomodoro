<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="icon" href="img/favicon.png" sizes="32x32">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,900' rel='stylesheet' type='text/css'>

    <!-- SEO -->
		<meta name="description" content="Pomodoro timer for developers.">
    <title>Pomodoro timer</title>

    <!-- Open graph -->
		<meta property="og:type" content="website">
		<meta property="og:title" content="Pomodoro timer">
		<meta property="og:description" content="Pomodoro timer for developers.">
		<meta property="og:url" content="http://afonsopacifer.github.io/react-pomodoro/">
		<meta property="og:image" content="http://afonsopacifer.github.io/react-pomodoro/img/share.png">

		<!-- Twitter cards -->
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:title" content="Pomodoro timer">
		<meta name="twitter:description" content="Pomodoro timer for developers.">
		<meta name="twitter:url" content="http://afonsopacifer.github.io/react-pomodoro/">
		<meta name="twitter:image" content="http://afonsopacifer.github.io/react-pomodoro/img/share.png">

		<!-- CSS <3 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css">
    <link rel="stylesheet" href="css/style.css">


  </head>
  <body>
    <div id="app"></div>
    <script type="text/JavaScript" src="bundle.js"></script>
    <script src="https://solid.github.io/releases/rdflib.js/rdflib-0.6.0.min.js"></script>
    <script src="https://solid.github.io/releases/solid.js/solid-0.14.1.min.js"></script>
    <script src="js/notie.js"></script>
    <script>
      var webize = {}
      webize.containerName = 'localStorage/';
      // $rdf is exported as a global when you load RDFLib, above
      var solid = require('solid')
      // Use Solid client here ...
      console.log('solid.js version: ' + solid.meta.version())

      document.addEventListener('keydown', function(e){
        if(e.keyCode == 76 && (e.ctrlKey || e.metaKey)){

          authEndpoint = 'https://databox.me/';
          webize.dologin = function() {
            // Get the current user
            solid.auth.login(authEndpoint).then(function(webid){
              // authentication succeeded; do something with the WebID string
              notie.alert(1, 'Success!  You are logged in as : ' + webid);

              solid.identity.getProfile(webid).then(function (parsedProfile) {
                console.log('getProfile result: %o', parsedProfile)
                console.log('Account storage root: %s', parsedProfile.storage) // array of URIs })
                webize.storage = parsedProfile.storage[0];
                console.log(webize.storage);
                notie.alert(1, 'storage found at : ' + webize.storage);

                var url = webize.storage + webize.containerName;
                solid.web.get(url).then(
                  function(response) {
                    console.log('Raw resource: %s', response.raw())
                  }
                ).catch(
                  function(err) {
                    console.log(err) // error object
                    // ...
                    var parentDir = 'https://example.org/'
                    var slug = 'localStorage'
                    var data = '<#this> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://rdfs.org/sioc/ns#Space> .'
                    var isContainer = true

                    solid.web.post(webize.storage, data, slug, true).then(
                      function(solidResponse) {
                        console.log(solidResponse)
                        // The resulting object has several useful properties.
                        // See lib/solid-response.js for details
                        // solidResponse.url - value of the Location header
                        // solidResponse.acl - url of acl resource
                        // solidResponse.meta - url of meta resource
                        notie.alert(1, 'localStorage container set up : ' + url);

                      }
                    ).catch(function(err){
                      notie.alert(1, err);
                      console.log(err) // error object
                      console.log(err.status) // contains the error status
                      console.log(err.xhr) // contains the xhr object
                    })

                  }
                )


              });

              webize.user = webid;
              window.user = webid;
            }).catch(function(err) {
              // authentication failed; display some error message
              alert(err);
            });
          };


          webize.dologin();
          return false;
        }

        if(e.keyCode == 83 && (e.ctrlKey || e.metaKey)){
          webize.save = function() {
            if (!webize.storage) return;

            var origin = location.origin.replace(/.*?:\/\//g, "");

            var uri = webize.storage + webize.containerName + origin;

            var state = JSON.parse(localStorage.getItem('state'))
            var turtle = '';
            turtle += '<'+origin+'> <urn:localStorage:time> "'+ state.time +'" .'
            console.log(turtle)

            solid.web.put(uri, turtle).then(
              function(solidResponse) {
                console.log(solidResponse)
                notie.alert(1, 'localStorage saved!');
                // The resulting object has several useful properties.
                // See lib/solid-response.js for details
                // solidResponse.url - value of the Location header
                // solidResponse.acl - url of acl resource
                // solidResponse.meta - url of meta resource
              }
            ).catch(function(err){
              notie.alert(1, err);
              console.log(err) // error object
              console.log(err.status) // contains the error status
              console.log(err.xhr) // contains the xhr object
            })

          }

          webize.save()

          return false
        };


        if(e.keyCode == 79 && (e.ctrlKey || e.metaKey)){
          webize.load = function() {
            if (!webize.storage) return;

            var origin = location.origin.replace(/.*?:\/\//g, "");

            var uri = webize.storage + webize.containerName + origin;


            solid.web.get(uri)
              .then(function(response) {
                if (response.isContainer()) {
                  // This is an instance of SolidContainer, see Listing Containers below
                  for (resourceUrl in response.resources) {
                    // iterate over resources
                  }
                  for (subcontainerUrl in response.containers) {
                    // iterate over sub-containers
                  }
                } else {
                  // Regular resource
                  console.log('Raw resource: %s', response.raw())
                  notie.alert(1, 'localStorage loaded!');

                  var graph = response.parsedGraph()
                  // Print all statements matching resources of type foaf:Post
                  var st = graph.statements[0].object.value;
                  console.log(st)
                  localStorage.setItem('state', JSON.stringify({"time" : st }))

                }
              })
              .catch(function(err) {
                  notie.alert(1, err);
                  console.log(err) // error object
                // ...
               })
          }

          webize.load()

          return false;
        };


      });

    </script>
  </body>
</html>
